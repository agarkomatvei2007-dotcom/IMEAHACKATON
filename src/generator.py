import google.generativeai as genai
from config import GEMINI_API_KEY
from google.api_core import exceptions


class Generator:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ Gemini API —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º —Ä–µ–∂–∏–º–æ–º RAG"""
    
    def __init__(self):
        if not GEMINI_API_KEY:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞ API
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω GEMINI_API_KEY –≤ .env —Ñ–∞–π–ª–µ!")
        
        genai.configure(api_key=GEMINI_API_KEY)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è 404 –æ—à–∏–±–æ–∫
        self.model = genai.GenerativeModel('gemini-2.5-flash') 
        print("‚úÖ Gemini API –ø–æ–¥–∫–ª—é—á–µ–Ω")
    
    def generate(self, question: str, context: str) -> str:
        """
        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, 
        –∏–Ω–∞—á–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è (Hybrid Mode).
        """
        
        # üìù –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ (–ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º –∏ –°–∏–Ω—Ç–µ–∑)
        prompt = f"""–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º —É—Å–ª—É–≥–∞–º –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{context}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
- –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ï—Å–ª–∏ **–∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω**, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –∫–∞–∫ **–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫** –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –°—Ç—Ä—É—Ç–∫—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —Å–ø–∏—Å–∫–æ–≤ –∏–ª–∏ –∂–∏—Ä–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞.
- –ï—Å–ª–∏ **–∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –∏–ª–∏ –ø—É—Å—Ç** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–∑—É "–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω..."), –∏—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è, —á—Ç–æ–±—ã –¥–∞—Ç—å –æ–±—â–∏–π, –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç.
- –ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **—Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è**, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å —Ñ—Ä–∞–∑—ã: "–ù–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π, –Ω–µ –∏–∑ –±–∞–∑—ã:"
- –ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π**, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–∏—Ö –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ (—ç—Ç–æ –ø–æ–ª–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –≤ app.py, —Ç–µ–±–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ).
- –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º —è–∑—ã–∫–æ–º.

–û—Ç–≤–µ—Ç:"""
        
        try:
            response = self.model.generate_content(prompt)
            
            if response.text:
                return response.text
            else:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
                block_reason = response.prompt_feedback.block_reason.name if response.prompt_feedback.block_reason else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                print(f"‚ö†Ô∏è Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü—Ä–∏—á–∏–Ω–∞: {block_reason}")
                return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø—Ä–æ—Å –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ AI."

        except exceptions.NotFound as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ 404 (NotFound): {e}")
            return "–û—à–∏–±–∫–∞: –ú–æ–¥–µ–ª—å AI –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º—è –º–æ–¥–µ–ª–∏ ('gemini-2.5-flash') –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
        except exceptions.ResourceExhausted as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ª–∏–º–∏—Ç–∞ (ResourceExhausted): {e}")
            return "–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        except Exception as e:
            # –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
            print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ API: {e}") 
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI."